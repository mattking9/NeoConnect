@page "/schedules"
@using NeoConnect
@inject IHeatingService _heatingService

<PageTitle>Schedules</PageTitle>

<h1>Schedules</h1>

@if (schedules == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-striped" width="100%">
        <thead>
            <tr>
                <th></th>
                <th colspan="4" style="text-align:center">Weekdays</th>
                <th colspan="4" style="text-align:center">Weekends</th>
            </tr>
            <tr>
                <th></th>
                <th style="text-align:center">Wake</th>
                <th style="text-align:center">Leave</th>
                <th style="text-align:center">Return</th>
                <th style="text-align:center">Sleep</th>
                <th style="text-align:center">Wake</th>
                <th style="text-align:center">Leave</th>
                <th style="text-align:center">Return</th>
                <th style="text-align:center">Sleep</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var profile in schedules)
            {
                <tr>
                    <th width="12%">@profile.Key</th>
                    
                    @foreach (var cl in profile.Value)
                    {
                        <td width="11%" style="text-align:center">@cl.Time.ToString(@"HH\:mm")<br /><span style="font-weight:bold;font-size:1.2em;">@cl.TargetTemp</span>°</td>
                    }

                </tr>
            }
        </tbody>
    </table>
}

@code {

    private Dictionary<string, ComfortLevel[]>? schedules;

    protected override async Task OnInitializedAsync()
    {
        await _heatingService.Init(CancellationToken.None);
        var profileData = await _heatingService.GetProfiles(CancellationToken.None);
        await _heatingService.Cleanup(CancellationToken.None);

        schedules = new Dictionary<string, ComfortLevel[]>();

        foreach (var profile in profileData)
        {
            var comfortLevels = new ComfortLevel[8];
            comfortLevels[0] = new ComfortLevel(profile.Value.Schedule.Weekdays.Wake);
            comfortLevels[1] = new ComfortLevel(profile.Value.Schedule.Weekdays.Leave);
            comfortLevels[2] = new ComfortLevel(profile.Value.Schedule.Weekdays.Return);
            comfortLevels[3] = new ComfortLevel(profile.Value.Schedule.Weekdays.Sleep);
            comfortLevels[4] = new ComfortLevel(profile.Value.Schedule.Weekends.Wake);
            comfortLevels[5] = new ComfortLevel(profile.Value.Schedule.Weekends.Leave);
            comfortLevels[6] = new ComfortLevel(profile.Value.Schedule.Weekends.Return);
            comfortLevels[7] = new ComfortLevel(profile.Value.Schedule.Weekends.Sleep);

            schedules.Add(profile.Value.ProfileName, comfortLevels);
        }
    }
}
